name: CI

on:
  push:
    branches:
      - '**'
  pull_request:
    branches:
      - '**'

jobs:
  test:
    name: Test & Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run type checks
        run: npm run test:types

      - name: Run linter
        run: npm run lint

      - name: Run knip
        run: npm run knip

      - name: Run tests with coverage
        run: npm run test:coverage

      - name: Verify 100% coverage
        run: |
          COVERAGE_OUTPUT=$(npm run test:coverage 2>&1)
          echo "$COVERAGE_OUTPUT"
          
          # Extract the "All files" line and parse coverage percentages
          ALL_FILES_LINE=$(echo "$COVERAGE_OUTPUT" | grep "All files")
          
          # Parse using pipe delimiter to extract each coverage type
          STATEMENTS=$(echo "$ALL_FILES_LINE" | awk -F"|" '{print $2}' | xargs)
          BRANCHES=$(echo "$ALL_FILES_LINE" | awk -F"|" '{print $3}' | xargs)
          FUNCTIONS=$(echo "$ALL_FILES_LINE" | awk -F"|" '{print $4}' | xargs)
          LINES=$(echo "$ALL_FILES_LINE" | awk -F"|" '{print $5}' | xargs)
          
          echo ""
          echo "Coverage Summary:"
          echo "  Statements: $STATEMENTS%"
          echo "  Branches: $BRANCHES%"
          echo "  Functions: $FUNCTIONS%"
          echo "  Lines: $LINES%"
          echo ""
          
          # Check if all coverage types are 100
          if [ "$STATEMENTS" != "100" ] || [ "$BRANCHES" != "100" ] || [ "$FUNCTIONS" != "100" ] || [ "$LINES" != "100" ]; then
            echo "❌ Coverage is not 100% for all types!"
            exit 1
          fi
          
          echo "✅ All coverage types are at 100%"
